from pycoin.serialize import b2h, h2b
from pycoin import encoding
import rlp
from ethereum import tester, utils, abi, blocks, transactions
import requests
import json
import jsonrpc
import time
from ethereum.abi import ContractTranslator
from ethereum.utils import mk_contract_address
from bike.parsing.fastparserast import Node


global_wait_for_confirm = True
use_ether_scan = False
use_augor = False
ether_scan_api_key = '66FCG5X3HSVW23R2ZJTFJEKWMKKGJVIQXK'
local_url = "http://localhost:8545/jsonrpc"
augor_local_url = "https://eth3.augur.net/jsonrpc"

def merge_two_dicts(x, y):
    '''Given two dicts, merge them into a new dict as a shallow copy.'''
    z = x.copy()
    z.update(y)
    return z

def etherscan_call(method_name, params):
    url = "https://koven.etherscan.io/api"
    payload = {"module" : "proxy",
               "action" : method_name,
               "apikey" : ether_scan_api_key }
    payload = merge_two_dicts(payload, params[0])
    response = requests.post(url, params=payload)
    #print str(response)
    return response.json()[ 'result' ]
    
    
def json_call(method_name, params):
    if use_ether_scan:
        return etherscan_call(method_name, params)
    url = local_url
    if use_augor:
        url = augor_local_url
    headers = {'content-type': 'application/json'}
    
    # Example echo method
    payload = { "method": method_name,
                "params": params,
                "jsonrpc": "2.0",
                "id": 1,
                }
    # print str(params)
    response = requests.post(url, data=json.dumps(payload), headers=headers).json()
    print str(response)
    #print response
    return response[ 'result' ]

global_nonce = -1
def get_num_transactions(address):
    #return "12d"
    #return "6"
    #return "0x546B"
    global global_nonce
    # if( global_nonce > 0 ):
    #    global_nonce += 1
    #    return "0x" + "%x" % global_nonce
    if use_ether_scan:
        params = [{ "address" : "0x" + address, "tag" : "pending" }]
    else:
        params = [ "0x" + address, "pending" ]
    nonce = json_call("eth_getTransactionCount", params)
    # print "nonce: " + str(nonce)
    global_nonce = int(nonce, 16)
    return nonce 

def get_gas_price_in_wei():
    if use_ether_scan:
        return "0x%x" % 20000000000  # 20 gwei
    return json_call("eth_gasPrice", [])

def eval_startgas(src, dst, value, data, gas_price):
    if use_ether_scan or True:
        return "0x%x" % (4712388 / 2)  # hardcoded max gas
        
    params = { "value" : "0x" + str(value),
               "pasPrice" : gas_price }
    if len(data) > 0:
        params["data"] = "0x" + str(data)
    if len(dst) > 0:
        params["to"] = "0x" + dst
    #           "from" : "0x" + dst }
    # params = { "from" : "0x06f099a7d789f10b0c1c1f069638ba25b2bf8483",
    #           "data" : "123456789" }
    # print str(params)
    return json_call("eth_estimateGas", [params])


def make_transaction(src_priv_key, dst_address, value, data):
    src_address = b2h(utils.privtoaddr(src_priv_key))
    nonce = get_num_transactions(src_address)
    #gas_price = get_gas_price_in_wei()
    data_as_string = b2h(data)
    # print len(data_as_string)
    # if len(data) > 0:
    #    data_as_string = "0x" + data_as_string 
    #start_gas = eval_startgas(src_address, dst_address, value, data_as_string, gas_price)
    start_gas = 10**6
    nonce = int(nonce, 16)
    #gas_price = int(gas_price, 16)
    gas_price = (10**10) * 20 
    #int(gas_price, 16)/20
    #start_gas = int(start_gas, 16) + 100000
    
    #start_gas = 4612288  # // 10
    #start_gas = 38336
    #start_gas = 30048
    # start_gas = 5000000    
    
    for i in range(1):
        tx = transactions.Transaction(nonce,
                                       gas_price,
                                       start_gas,
                                       dst_address,
                                       value,
                                       data).sign(src_priv_key)
        
        
                                       
        tx_hex = b2h(rlp.encode(tx))
        print tx_hex
        tx_hash = b2h(tx.hash)

                        
        #print(tx_hex)
        # print str(tx_hash)
        if use_ether_scan:
            params = [{"hex" : "0x" + tx_hex }]
        else:
            params = ["0x" + tx_hex]
        return_value = json_call("eth_sendRawTransaction", params)                       
        if return_value == "0x0000000000000000000000000000000000000000000000000000000000000000":
            print "Transaction failed"
            return return_value
        
        nonce += 1
        print str(nonce)
    wait_for_confirmation(tx_hash)
    return return_value        

    
def get_contract_data(contract_name, ctor_args):
    bin_file = open(contract_name + ".bin", "rb")
    bin = h2b(bin_file.read())
    # print bin
    bin_file.close()
    #bin = h2b("60a0604052600560608190527f302e312e31000000000000000000000000000000000000000000000000000000608090815262000040916002919062000121565b506004805460ff191690556002600955604051606080620041b4833981016040525b5b5b5b5b5b5b600160008083815b60209081029190910151600160a060020a031682528101919091526040016000908120805460ff1916921515929092179091556001908083835b60209081029190910151600160a060020a031682528101919091526040016000908120805460ff191692151592909217909155600190808360025b60209081029190910151600160a060020a03168252810191909152604001600020805460ff1916911515919091179055436003555b50620001cb565b828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f106200016457805160ff191683800117855562000194565b8280016001018555821562000194579182015b828111156200019457825182559160200191906001019062000177565b5b50620001a3929150620001a7565b5090565b620001c891905b80821115620001a35760008155600101620001ae565b5090565b90565b613fd980620001db6000396000f300606060405236156101175763ffffffff60e060020a600035041663022914a781146101285780630289e966146101585780630e9b62811461017c5780630f136527146101915780631bf30929146101bf57806321b5b8dd146101e1578063320d46d41461020357806335ffbe741461023357806340ed79f4146103875780634420e4861461044557806354fd4d50146104635780636e821b2e146104f35780637087ed2c146105385780637dcfd50814610566578063a331a9641461058e578063c3c5a547146105b6578063c891a29d146105e6578063deb5364514610649578063e2dea7151461066b578063e3d8699814610699578063e7dac983146106ab578063ee385304146106cc578063ff5d2c39146106f3575b6101265b60088054340190555b565b005b341561013057fe5b610144600160a060020a036004351661071b565b604080519115158252519081900360200190f35b341561016057fe5b610144610730565b604080519115158252519081900360200190f35b341561018457fe5b610126600435610739565b005b341561019957fe5b6101ad600160a060020a0360043516610779565b60408051918252519081900360200190f35b34156101c757fe5b6101ad6107b2565b60408051918252519081900360200190f35b34156101e957fe5b6101ad6107b8565b60408051918252519081900360200190f35b341561020b57fe5b610144600160a060020a03600435166107be565b604080519115158252519081900360200190f35b341561023b57fe5b6101ad600480803590602001908201803590602001908080601f016020809104026020016040519081016040528093929190818152602001838380828437505060408051818801358901803560208181028481018201909552818452989a8a359a8a8101359a9199506060019750929550908201935091829185019084908082843750506040805187358901803560208181028481018201909552818452989a998901989297509082019550935083925085019084908082843750506040805187358901803560208181028481018201909552818452989a998901989297509082019550935083925085019084908082843750506040805187358901803560208181028481018201909552818452989a99890198929750908201955093508392508501908490808284375094965061080495505050505050565b60408051918252519081900360200190f35b341561038f57fe5b60408051604435600481810135602081810285810182019096528185526101ad9583359577ffffffffffffffffffffffffffffffffffffffffffffffff196024803591909116966064959294910192829185019084908082843750506040805187358901803560208181028481018201909552818452989a9989019892975090820195509350839250850190849080828437509496505093359350610da392505050565b60408051918252519081900360200190f35b341561044d57fe5b610126600160a060020a03600435166110d0565b005b341561046b57fe5b610473611271565b6040805160208082528351818301528351919283929083019185019080838382156104b9575b8051825260208311156104b957601f199092019160209182019101610499565b505050905090810190601f1680156104e55780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b34156104fb57fe5b6105066004356112fc565b604080516001608060020a0390941684526001604060020a039283166020850152911682820152519081900360600190f35b341561054057fe5b6101ad600160a060020a0360043516611333565b60408051918252519081900360200190f35b341561056e57fe5b6101ad600435602435611427565b60408051918252519081900360200190f35b341561059657fe5b6101ad60043560243561148b565b60408051918252519081900360200190f35b34156105be57fe5b610144600160a060020a03600435166114b4565b604080519115158252519081900360200190f35b34156105ee57fe5b60408051602060046064358181013583810280860185019096528085526101269583359560248035966044359695608495939492019291829185019084908082843750949650508435946020013593506114da92505050565b005b341561065157fe5b6101ad611682565b60408051918252519081900360200190f35b341561067357fe5b6101ad600160a060020a0360043516611688565b60408051918252519081900360200190f35b34156106a157fe5b6101266116a7565b005b34156106b357fe5b610126600435602435604435606435608435611714565b005b34156106d457fe5b6101446004356119a8565b604080519115158252519081900360200190f35b34156106fb57fe5b6101ad6004356024356119bd565b60408051918252519081900360200190f35b60006020819052908152604090205460ff1681565b60045460ff1681565b600160a060020a03331660009081526020819052604090205460ff1615156107615760006000fd5b60018110156107705760006000fd5b60098190555b50565b600160a060020a0381166000908152600560205260408120600201805461079f84611333565b8115156107a857fe5b0691505b50919050565b60035481565b60085481565b600080806802d227003d8d2af800600160a060020a0385165b0691506107e582600b6119bd565b60008181526006602052604090205460ff1615935090505b5050919050565b600061080e613ccb565b610816613d06565b60006000610822613d3d565b600061082d8e611a49565b95506005600033600160a060020a0316600160a060020a0316815260200190815260200160002060020160c06040519081016040529081600082015481526020016001820154815260200160028201548152602001600382015481526020016004820154815260200160058201548152505094506108aa33611333565b15156108ef576040805163840000018152600060208201528151600160a060020a03331692600080516020613f8e833981519152928290030190a26101219650610d92565b6108f833610779565b8c146109475733600160a060020a0316600080516020613f8e833981519152638400000261092533610779565b6040805192835260208301919091528051918290030190a261024d9650610d92565b600160a060020a03331660009081526005602052604090206008015460ff1615156109aa576040805163840000038152600060208201528151600160a060020a03331692600080516020613f8e833981519152928290030190a260bd9650610d92565b60a0860151600160a060020a033316600090815260056020908152604090912054908701516109da929190611b7c565b1515610a255760a0860151604080516384000004815260208101929092528051600160a060020a03331692600080516020613f8e83398151915292908290030190a260029650610d92565b6020860151600160a060020a03301614610a815733600160a060020a0316600080516020613f8e83398151915263840000058860200151604051808381526020018281526020019250505060405180910390a260039650610d92565b8c8660800151604060020a020193508460400151841015610b195760408051638000000c81526020810186905281517ff2223b217ee93efaf9c3f20e711d59a7fac6a5b5d58418ec8086005f51d8a278929181900390910190a16040805163840000078152602081018690528151600160a060020a03331692600080516020613f8e833981519152928290030190a260049650610d92565b8460600151841115610b63576040805163840000088152602081018690528151600160a060020a03331692600080516020613f8e833981519152928290030190a260059650610d92565b8d6040518082805190602001908083835b60208310610b935780518252601f199092019160209182019101610b74565b51815160209384036101000a6000190180199092169116179052604080519290940182900390912060808b81015189528b850151928901929092526060808c0151948901949094529287018390528601889052509450610bf991508390508d8b8b611cfd565b1515610c3d576040805163840000098152600060208201528151600160a060020a03331692600080516020613f8e833981519152928290030190a260069650610d92565b610c64836001028e60c060020a028d8d6175308b60400151811515610c5e57fe5b04610da3565b90508460200151600019811515610c7757fe5b04811115610cbd5760408051638400000b8152602081018390528151600160a060020a03331692600080516020613f8e833981519152928290030190a260079650610d92565b600160a060020a03338116600090815260056020908152604090912060088101805460ff19169055875191880151600190910154610cfb9316612101565b1515610d0a5760139650610d92565b84516020808701516040805142815292830193909352818301529051600160a060020a033316917febe2151e37e4487a7208c7b98bdf4c0a7a2918639267814765d5aea623dcfc9c919081900360600190a260408051600080825260208201528151600160a060020a03331692600080516020613f8e833981519152928290030190a2600896505b505050505050979650505050505050565b6000610dad613d6d565b610db5613d96565b610dbd613dbf565b610dc5613de8565b506040805180820182526000878152600160208181529382206102018101548452898352818552610200015493830193909352909181908190819085905b60200201511515610e5857604080518b81526000602082018190528183015290517f5a0558a816733f830622a7b7e92bbe72bf918ca59267ad49ec7b15277bc16aed9181900360600190a160001998506110bf565b610e688e60c060020a8f04612206565b9750600093505b6010841015610e9b5760208402888101805191890191825251610200909101525b600190930192610e6f565b600093505b6040841015610fe4578460015b6020020151610ee28960005b6020020151861889602088811515610ecd57fe5b0660208110610ed857fe5b60200201516122a8565b811515610eeb57fe5b069150610ef88a83611427565b610f0d83868f8f8a60005b60200201516122be565b14610f1c5760001998506110bf565b600092505b6008831015610fd857602060808581028e0182810180519387028b01805163ffffffff9586166301000193918202188616825260408401805161010084018051918916918402919091188816905260608501805161020085018051918a1691850291909118891690529490950180516103009093018051938816939092029290921890951690945280516401000000009081900490915282518190049092528051829004905281510490525b600190920191610f21565b5b600190930192610ea0565b600093505b602084101561107a5761105961104061102789876020811061100757fe5b60200201518a88600101602081101515610ed857fe5b60200201516122a8565b896002880160208110610ed857fe5b60200201516122a8565b886003870160208110610ed857fe5b60200201516122a8565b866004865b046008811061106957fe5b60200201525b600484019350610fe9565b611084888761244f565b6040805182815290519192507f909c57d5c6ac08245cf2a6de3900e2b868513fa59099b92b27d8db823d92df9c919081900360200190a18098505b505050505050505095945050505050565b336000806802d227003d8d2af800600160a060020a0384165b0691506110f782600b6119bd565b600160a060020a0384166000908152600560209081526040808320548352600690915290205490915060ff1615611174576040805163800000008152602081018390528151600160a060020a033316927f1d759fb22634fe2d322d688a4b46aaf185dd0a3db78ccf01a9218f00ac3df03f928290030190a261126b565b600160a060020a03841615156111d3576040805163800000018152600160a060020a038681166020830152825133909116927f1d759fb22634fe2d322d688a4b46aaf185dd0a3db78ccf01a9218f00ac3df03f928290030190a261126b565b600160a060020a0383811660009081526005602090815260408083206001808201805473ffffffffffffffffffffffffffffffffffffffff19168b88161790559086905585845260068352818420805460ff19169091179055805183815291820192909252815133909316927f1d759fb22634fe2d322d688a4b46aaf185dd0a3db78ccf01a9218f00ac3df03f929181900390910190a25b50505050565b6002805460408051602060018416156101000260001901909316849004601f810184900484028201840190925281815292918301828280156112f45780601f106112c9576101008083540402835291602001916112f4565b820191906000526020600020905b8154815290600101906020018083116112d757829003601f168201915b505050505081565b6007602052600090815260409020546001608060020a038116906001604060020a03608060020a820481169160c060020a90041683565b600061133d613e10565b50600160a060020a03808316600090815260056020818152604092839020835160a0818101865282548252600183015490961681840152845160c08101865260028301548152600383015493810193909352600482015483860152928101546060808401919091526006820154608080850191909152600783015496840196875294840192909252600881015460ff161515918301919091526009015491810191909152905160c8014311156113f657600091506107ac565b604081015160a00151600101431161141157600091506107ac565b604081015160a001516001014091505b50919050565b6000828152600160205260408120610201810154600290810a8404918391835b04610200811061145357fe5b0160005b505490506002825b061515611474576001608060020a031661147f565b608060020a815b0490505b8092505b505092915050565b60008281526001602052604081208261020081106114a557fe5b0160005b505490505b92915050565b600160a060020a038181166000908152600560205260409020600101541615155b919050565b600160a060020a03331660009081526020819052604081205460ff161515611549576040805163820000008152600160a060020a03331660208201819052825190927f5cd723400be8430351b9cbaa5ea421b3fb2528c6a7650c493f895e7d97750da1928290030190a2611679565b5060005b81811015611617576000878152600160205260408120848301610200811061157157fe5b0160005b505411156115d2576040805163820000018152608060020a89028501830160208201528151600160a060020a033316927f5cd723400be8430351b9cbaa5ea421b3fb2528c6a7650c493f895e7d97750da1928290030190a261160f565b83818151811015156115e057fe5b6020908102909101810151600089815260019092526040909120848301610200811061160857fe5b0160005b50555b60010161154d565b600087815260016020908152604080832061020081018a9055610201018890558051838152918201929092528151600160a060020a033316927f5cd723400be8430351b9cbaa5ea421b3fb2528c6a7650c493f895e7d97750da1928290030190a25b50505050505050565b60095481565b600160a060020a0381166000908152600560205260409020545b919050565b600160a060020a03331660009081526020819052604090205460ff1615156116cf5760006000fd5b6004805460ff19166001179055604051600160a060020a0333811691309091163180156108fc02916000818181858888f1935050505015156101245760006000fd5b5b565b61171c613e10565b611724613e10565b61172d336114b4565b151561177f576040805163810000008152600060208201528151600160a060020a033316927f53ab9d877ae22286591454f9a8d58501caa34a07c99eac2c09bc0066c065400d928290030190a2611679565b600160a060020a03338116600090815260056020818152604092839020835160a0818101865282548252600183015490961681840152845160c0810186526002830154815260038301549381019390935260048201548386015292810154606080840191909152600682015460808085019190915260078301549684019690965293830191909152600881015460ff161515928201929092526009909101549181018290529250859010611880576080820151604080516381000001815260208101929092528051600160a060020a033316927f53ab9d877ae22286591454f9a8d58501caa34a07c99eac2c09bc0066c065400d92908290030190a2611679565b506080818101848152604080840180518a9052805160209081018a905281518301899052815160609081018990528251860188905282514360a091820152600182890181815233600160a060020a03908116600081815260058089528a82208e518155898f0151968101805473ffffffffffffffffffffffffffffffffffffffff19169790951696909617909355975180516002860155808801516003860155808a01516004860155958601519184019190915598840151600683015592909101516007820155905160088201805460ff1916911515919091179055935160099094019390935581518181529283015280518493927f53ab9d877ae22286591454f9a8d58501caa34a07c99eac2c09bc0066c065400d92908290030190a25b50505050505050565b60066020526000908152604090205460ff1681565b600080808080603e86900a87106119d45760006000fd5b60009350600092505b85831015611a3857603e875b069150600a8210156119ff575060308101611a18565b6024821015611a12575060578101611a18565b50601d81015b5b61010090930260ff84160192603e875b0496505b6001909201916119dd565b8360010294505b5050505092915050565b611a51613ccb565b611a59613ccb565b611a61613e44565b6000611a74611a6f86612630565b612684565b91505b611a80826126c2565b15611b7057801515611aa457611a9d611a98836126e8565b612739565b8352611b63565b8060021415611ac857611abe611a98836126e8565b612739565b6020840152611b63565b8060081415611aec57611ae2611a98836126e8565b612739565b6040840152611b63565b80600a1415611b1057611b06611a98836126e8565b612739565b6060840152611b63565b80600b1415611b3457611b2a611a98836126e8565b612739565b6080840152611b63565b80600c1415611b5857611b4e611a98836126e8565b612739565b60a0840152611b63565b611b61826126e8565b505b5b5b5b5b5b600101611a77565b8293505b505050919050565b600080805b600b821015611c2f57846015830160208110611b9957fe5b1a60f860020a02600160f860020a0319168683600a01602081101515611bbb57fe5b1a60f860020a02600160f860020a031916141515611c23576040805163830000008152602081018790528151600160a060020a033316927f1f663d8c427e3fbf090ed8c66536b06651bca95051509e3a45cb1cbb286312e8928290030190a260009250611cf4565b5b600190910190611b81565b611c3a84600b6119bd565b9050600091505b600b821015611cef57806015830160208110611c5957fe5b1a60f860020a02600160f860020a0319168683601501602081101515611c7b57fe5b1a60f860020a02600160f860020a031916141515611ce3576040805163830000018152602081018390528151600160a060020a033316927f1f663d8c427e3fbf090ed8c66536b06651bca95051509e3a45cb1cbb286312e8928290030190a260009250611cf4565b5b600190910190611c41565b600192505b50509392505050565b606084015160808501516000916001608060020a03169082908190819081908190819080825b8c51811015611fb55760008e6001161115611da5578c81815181101515611d4657fe5b906020019060200201516001608060020a0316985060808d82815181101515611d6b57fe5b906020019060200201519060020a900497508b81815181101515611d8b57fe5b906020019060200201519650829550819450899350611e0e565b8298508197508996508c81815181101515611dbc57fe5b906020019060200201516001608060020a0316955060808d82815181101515611de157fe5b906020019060200201519060020a900494508b81815181101515611e0157fe5b9060200190602002015193505b60408051608060020a808b028c018252602082018a905287028801818301526060810186905290519081900360800190206001608060020a031699508789101580611e595750848610155b15611f8e576000811115611ec45760408051602081018390528181526011818301527f636f756e74657273206d69736d6174636800000000000000000000000000000060608201529051600080516020613f6e8339815191529181900360800190a160009a506120ef565b87891115611f295760408051602081018390528181526011818301527f636f756e74657273206d69736d6174636800000000000000000000000000000060608201529051600080516020613f6e8339815191529181900360800190a160009a506120ef565b84861115611f8e5760408051602081018390528181526011818301527f636f756e74657273206d69736d6174636800000000000000000000000000000060608201529051600080516020613f6e8339815191529181900360800190a160009a506120ef565b5b858810611f9f5760009a506120ef565b88925084915060028e5b049d505b600101611d23565b60208f0151831461201d576040805160208101859052818152601b818301527f6d696e20646f6573206e6f74206d6174636820726f6f74206d696e000000000060608201529051600080516020613f6e8339815191529181900360800190a160009a506120ef565b60408f01518214612085576040805160208101849052818152601b818301527f6d617820646f6573206e6f74206d6174636820726f6f74206d6178000000000060608201529051600080516020613f6e8339815191529181900360800190a160009a506120ef565b8e518a146120ea5760408051602081018c9052818152601d818301527f6861736820646f6573206e6f74206d6174636820726f6f74206861736800000060608201529051600080516020613f6e8339815191529181900360800190a160009a506120ef565b60019a505b50505050505050505050949350505050565b6000600060006000600044111561211a57449250612121565b620186a092505b828787674563918244f40000020281151561213857fe5b04915030600160a060020a03163182111561218b576040805163840000008152602081018490528151600160a060020a03331692600080516020613f8e833981519152928290030190a2600093506121fc565b600160095403820290506008548111806121b0575030600160a060020a031631818301115b156121b9575060005b60088054829003905560405191810191600160a060020a0386169083156108fc029084906000818181858888f1935050505015156121f75760006000fd5b600193505b5050509392505050565b61220e613d6d565b612216613e65565b61221f8461278e565b93506001604060020a0384168160005b6020020152604060020a845b0493506001604060020a0384168160015b6020020152604060020a845b0493506001604060020a0384168160025b6020020152604060020a845b0493506001604060020a0384168160035b6020020152828160045b602002015261229e816127c1565b91505b5092915050565b63ffffffff630100019383028218165b92915050565b600060006000600060006000600060006122d88b8d6129b7565b6001608060020a03169650600060028a5b06119250600289049850888c029150821561230357908b01905b5060005b888110156123d25760208282010260208b01015193508c6001166000141561233d578695506001608060020a038416945061234d565b6001608060020a03841695508694505b604080518781526020810187905281519081900390910190206002909d049c6001608060020a0316965060018d16151561239257869550608060020a8404945061239f565b608060020a840495508694505b604080518781526020810187905281519081900390910190206002909d049c6001608060020a031696505b600101612307565b821561243b5760208282010260208b01015193508c60011660001415612406578695506001608060020a0384169450612416565b6001608060020a03841695508694505b604080518781526020810187905281519081900390910190206001608060020a031696505b8697505b5050505050505095945050505050565b60008080808560075b6020020151606060020a028660065b6020020151604060020a028760055b6020020151640100000000028860045b6020020151010101608060020a028660036010811015156124a357fe5b6020020151606060020a028760025b6020020151604060020a028860015b6020020151640100000000028960005b602002015101010101925085600f5b6020020151606060020a0286600e5b6020020151604060020a0287600d5b60200201516401000000000288600c5b6020020151010101608060020a0286600b60108110151561252b57fe5b6020020151606060020a0287600a5b6020020151604060020a028860095b6020020151640100000000028960085b60200201510101010191508460075b6020020151606060020a028560065b6020020151604060020a028660055b6020020151640100000000028760045b6020020151010101608060020a028560036008811015156125b357fe5b6020020151606060020a028660025b6020020151604060020a028760015b6020020151640100000000028860005b60200201510101010190506125f58361278e565b6125fe8361278e565b6126078361278e565b604080519384526020840192909252828201525190819003606001902093505b50505092915050565b612638613e8e565b8151600081151561265e57604080518082019091526000808252602082015292506107fd565b6020840190506040604051908101604052808281526020018381525092505b5050919050565b61268c613e44565b600061269783612a92565b15156126a35760006000fd5b6126ac83612ac5565b8351848452016020830181905290505b50919050565b60006126cc613e8e565b5050805160208082015182519184015191019010905b50919050565b6126f0613e8e565b600060006126fd846126c2565b1561272b578360200151915061271282612b4b565b82845260208085018290528382019086015290506107fd565b60006000fd5b5b5050919050565b60006000600061274884612bdd565b15156127545760006000fd5b61275d84612c0f565b91509150602081118061276e575080155b156127795760006000fd5b806020036101000a82510492505b5050919050565b600080805b60208110156127b65760ff84166101009283020191845b0493505b600101612793565b8192505b5050919050565b6127c9613d6d565b6000600060006127d7613ea5565b6000600060006127e5613d6d565b60005b60018b60055b6020020152603f60020a8b60085b60200201526048985060089750889650600094505b888781151561281c57fe5b048510156128d057600093505b60058410156128b957600092505b60058310156128ad57878981151561284b57fe5b0484600502840110156128a1578a60098087028501600587020190811061286e57fe5b6020020151866005850286016019811061288457fe5b602002015118866005850286016019811061289b57fe5b60200201525b5b600190920191612837565b5b600190930192612829565b6128c286612c90565b95505b600190940193612811565b5060005b60108110156129a557600093505b60058410156129a057600092505b600583101561299457878981151561290457fe5b048460050284011080156129185750601081105b1561298857856005840285016019811061292e57fe5b602002015163ffffffff1682826010811061294557fe5b6020020152640100000000866005850286016019811061296157fe5b602002015181151561296f57fe5b0482600183016010811061297f57fe5b60200201526002015b5b6001909201916128f0565b5b6001909301926128e2565b6128d4565b8199505b505050505050505050919050565b600082826004028151811015156129ca57fe5b9060200190602002015183836004026001018151811015156129e857fe5b906020019060200201518484600402600201815181101515612a0657fe5b906020019060200201518585600402600301815181101515612a2457fe5b602090810290910181015160408051958652918501939093528381019190915260608301919091525190819003608001902090505b92915050565b600080805b60208110156127b65760ff84166101009283020191845b0493505b600101612793565b8192505b5050919050565b60006000826020015160001415612aac57600091506107ac565b8260000151905060c0815160001a101591505b50919050565b600060006000836020015160001415612ae157600092506107fd565b50508151805160001a906080821015612afd57600092506107fd565b60b8821080612b18575060c08210158015612b18575060f882105b5b15612b2757600192506107fd565b60c0821015612b3c5760b519820192506107fd565b60f519820192505b5050919050565b8051600090811a6080811015612b6457600191506107ac565b60b8811015612b7957607e19810191506107ac565b60c0811015612ba257600183015160b76020839003016101000a9004810160b5190191506107ac565b60f8811015612bb75760be19810191506107ac565b600183015160f76020839003016101000a9004810160f5190191505b5b5b5b5b50919050565b60006000826020015160001415612bf757600091506107ac565b8260000151905060c0815160001a1091505b50919050565b60006000600060006000612c2286612bdd565b1515612c2e5760006000fd5b8551805160001a935091506080831015612c4e5781945060019350612c87565b60b8831015612c6c5760018660200151039350816001019450612c87565b60b78303905080600187602001510303935080820160010194505b5b505050915091565b612c98613ea5565b612ca0613ece565b612ca8613ece565b60006000612cb4613ea5565b612cbc613ef6565b50604080516103008101825260018152618082602082015267800000000000808a91810191909152678000000080008000606082015261808b6080820152638000000160a0820181905267800000008000808160c0830181905267800000000000800960e0840152608a61010084015260886101208401526380008009610140840152638000000a610160840152638000808b61018084015267800000000000008b6101a08401526780000000000080896101c08401526780000000000080036101e084015267800000000000800261020084015267800000000000008061022084015261800a61024084015267800000008000000a6102608401526102808301526780000000000080806102a08301526102c08201526780000000800080086102e082015260005b6018811015613cbb578860045b60200201518960035b60200201518a60025b60200201518b60015b60200201518c60005b6020020151181818188760005b60200201528860095b60200201518960085b60200201518a60075b60200201518b60065b60200201518c60055b6020020151181818188760015b602002015288600e5b602002015189600d5b60200201518a600c5b60200201518b600b5b60200201518c600a5b6020020151181818188760025b60200201528860135b60200201518960125b60200201518a60115b60200201518b60105b60200201518c600f5b6020020151181818188760035b60200201528860185b60200201518960175b60200201518a60165b60200201518b60155b60200201518c60145b6020020151181818188760045b6020020152603f60020a8760015b6020020151811515612f2757fe5b048760015b60200201516002026001604060020a0316178760045b6020020151188660005b6020020152603f60020a8760025b6020020151811515612f6857fe5b048760025b60200201516002026001604060020a0316178760005b6020020151188660015b6020020152603f60020a8760035b6020020151811515612fa957fe5b048760035b60200201516002026001604060020a0316178760015b6020020151188660025b6020020152603f60020a8760045b6020020151811515612fea57fe5b048760045b60200201516002026001604060020a03161787600260058110151561301057fe5b6020020151188660035b6020020152603f60020a8760005b602002015181151561303657fe5b048760005b60200201516002026001604060020a0316178760035b6020020151188660045b60200201528560005b60200201518960005b6020020151188960005b60200201528560005b60200201518960015b6020020151188960015b60200201528560005b60200201518960025b6020020151188960025b60200201528560005b60200201518960035b6020020151188960035b60200201528560005b60200201518960045b6020020151188960045b60200201528560015b60200201518960055b6020020151188960055b60200201528560015b60200201518960065b6020020151188960065b60200201528560015b60200201518960075b6020020151188960075b60200201528560015b60200201518960085b6020020151188960085b60200201528560015b60200201518960095b6020020151188960095b60200201528560025b602002015189600a5b60200201511889600a5b60200201528560025b602002015189600b5b60200201511889600b5b60200201528560025b602002015189600c5b60200201511889600c5b60200201528560025b602002015189600d5b60200201511889600d5b60200201528560025b602002015189600e5b60200201511889600e5b60200201528560035b602002015189600f5b60200201511889600f5b60200201528560035b60200201518960105b6020020151188960105b60200201528560035b60200201518960115b6020020151188960115b60200201528560035b60200201518960125b6020020151188960125b60200201528560035b60200201518960135b6020020151188960135b60200201528560045b60200201518960145b6020020151188960145b60200201528560045b60200201518960155b6020020151188960155b60200201528560045b60200201518960165b6020020151188960165b60200201528560045b60200201518960175b6020020151188960175b60200201528560045b60200201518960185b6020020151188960185b60200201528860005b60200201518360005b602002015263100000008960015b602002015181151561334557fe5b048960015b6020020151641000000000026001604060020a0316178360085b60200201526720000000000000008960025b602002015181151561338457fe5b048960025b60200201516008026001604060020a03161783600b5b6020020152628000008960035b60200201518115156133ba57fe5b048960035b602002015165020000000000026001604060020a0316178360135b6020020152654000000000008960045b60200201518115156133f857fe5b048960045b602002015162040000026001604060020a0316178360165b6020020152603f60020a8960055b602002015181151561343157fe5b048960055b60200201516002026001604060020a03161783600260198110151561345757fe5b6020020152621000008960065b602002015181151561347257fe5b048960065b602002015165100000000000026001604060020a0316178360055b602002015266400000000000008960075b60200201518115156134b157fe5b048960075b6020020151610400026001604060020a03161783600d5b6020020152620800008960085b60200201518115156134e857fe5b048960085b602002015165200000000000026001604060020a0316178360105b60200201526740000000000000008960095b602002015181151561352857fe5b048960095b60200201516004026001604060020a0316178360185b6020020152600489600a5b602002015181151561355c57fe5b0489600a5b6020020151674000000000000000026001604060020a0316178360045b602002015267040000000000000089600b5b602002015181151561359e57fe5b0489600b5b60200201516040026001604060020a0316178360075b60200201526220000089600c5b60200201518115156135d457fe5b0489600c5b602002015165080000000000026001604060020a03161783600a5b6020020152660200000000000089600d5b602002015181151561361357fe5b0489600d5b6020020151618000026001604060020a0316178360125b6020020152600889600e5b602002015181151561364857fe5b0489600e5b6020020151672000000000000000026001604060020a0316178360155b602002015264100000000089600f5b602002015181151561368757fe5b0489600f5b60200201516310000000026001604060020a0316178360015b60200201526102008960105b60200201518115156136bf57fe5b048960105b60200201516680000000000000026001604060020a0316178360095b60200201526480000000008960115b60200201518115156136fd57fe5b048960115b60200201516302000000026001604060020a03161783600c5b6020020152650800000000008960125b602002015181151561373957fe5b048960125b602002015162200000026001604060020a03161783600f5b60200201526101008960135b602002015181151561377057fe5b048960135b6020020151670100000000000000026001604060020a0316178360175b60200201526420000000008960145b60200201518115156137af57fe5b048960145b60200201516308000000026001604060020a0316178360035b6020020152651000000000008960155b60200201518115156137eb57fe5b048960155b602002015162100000026001604060020a0316178360065b602002015263020000008960165b602002015181151561382457fe5b048960165b6020020151648000000000026001604060020a03161783600e5b60200201526701000000000000008960175b602002015181151561386357fe5b048960175b6020020151610100026001604060020a0316178360115b602002015266040000000000008960185b602002015181151561389e57fe5b048960185b6020020151614000026001604060020a0316178360145b602002015282600a5b60200201518360055b602002015119168360005b6020020151188960005b602002015282600b5b60200201518360065b602002015119168360015b6020020151188960015b602002015282600c5b60200201518360075b602002015119168360025b6020020151188960025b602002015282600d5b60200201518360085b602002015119168360035b6020020151188960035b602002015282600e5b60200201518360095b602002015119168360045b6020020151188960045b602002015282600f5b602002015183600a5b602002015119168360055b6020020151188960055b60200201528260105b602002015183600b5b602002015119168360065b6020020151188960065b60200201528260115b602002015183600c5b602002015119168360075b6020020151188960075b60200201528260125b602002015183600d5b602002015119168360085b6020020151188960085b60200201528260135b602002015183600e5b602002015119168360095b6020020151188960095b60200201528260145b602002015183600f5b6020020151191683600a5b60200201511889600a5b60200201528260155b60200201518360105b6020020151191683600b5b60200201511889600b5b60200201528260165b60200201518360115b6020020151191683600c5b60200201511889600c5b60200201528260175b60200201518360125b6020020151191683600d5b60200201511889600d5b60200201528260185b60200201518360135b6020020151191683600e5b60200201511889600e5b60200201528260005b60200201518360145b6020020151191683600f5b60200201511889600f5b60200201528260015b60200201518360155b602002015119168360105b6020020151188960105b60200201528260025b60200201518360165b602002015119168360115b6020020151188960115b60200201528260035b60200201518360175b602002015119168360125b6020020151188960125b60200201528260045b60200201518360185b602002015119168360135b6020020151188960135b60200201528260055b60200201518360005b602002015119168360145b6020020151188960145b60200201528260065b60200201518360015b602002015119168360155b6020020151188960155b60200201528260075b60200201518360025b602002015119168360165b6020020151188960165b60200201528260085b60200201518360035b602002015119168360175b6020020151188960175b60200201528260095b60200201518360045b602002015119168360185b6020020151188960185b6020020152818160188110613c9a57fe5b60200201518960005b6020020151188960005b60200201525b600101612de5565b8897505b50505050505050919050565b60c060405190810160405280600081526020016000815260200160008152602001600081526020016000815260200160006000191681525090565b60c0604051908101604052806000815260200160008152602001600081526020016000815260200160008152602001600081525090565b60a06040519081016040528060008152602001600081526020016000815260200160008152602001600081525090565b610200604051908101604052806010905b6000815260200190600190039081613d7e5790505090565b610400604051908101604052806020905b6000815260200190600190039081613d7e5790505090565b610100604051908101604052806008905b6000815260200190600190039081613d7e5790505090565b6040604051908101604052806002905b6000815260200190600190039081613d7e5790505090565b604080516101408101825260008082526020820152908101613e30613d06565b815260006020820181905260409091015290565b606060405190810160405280613e58613e8e565b8152602001600081525090565b610120604051908101604052806009905b6000815260200190600190039081613d7e5790505090565b604080518082019091526000808252602082015290565b610320604051908101604052806019905b6000815260200190600190039081613d7e5790505090565b60a0604051908101604052806005905b6000815260200190600190039081613d7e5790505090565b610300604051908101604052806018905b6000815260200190600190039081613d7e5790505090565b60c0604051908101604052806000815260200160008152602001600081526020016000815260200160008152602001600081525090565b604080518082019091526000808252602082015290560004a027a2ec1b8dd3a88b43842124c099e616f3633aec2eb618ce26757221f3c1096caf97202169a068288f02e51ff9fcc85f98e1477f6ad9acbf6ebf25dbcd00a165627a7a72305820f82a616269b1c2501f3799ab3df6497bfa20768ba33a66b5098990dfeea7d00f0029")
    
    abi_file = open(contract_name + ".abi", "r")
    abi = abi_file.read()
    abi_file.close()
    
    translator = ContractTranslator(abi)
    ctor_call = translator.encode_constructor_arguments(ctor_args)
    print "ctor"
    print b2h(ctor_call)
    
        
    return (bin + ctor_call, abi)
    
def upload_contract(priv_key, contract_data, value):
    src_address = b2h(utils.privtoaddr(priv_key))
    nonce = get_num_transactions(src_address)
    print "nonce"
    print str(nonce)
    gas_price = get_gas_price_in_wei()
    start_gas = eval_startgas(src_address, "", value, b2h(contract_data), gas_price)    
    
    contract_hash = b2h(mk_contract_address(src_address, int(nonce, 16))) 
    print "contract hash"
    print contract_hash
    
    nonce = int(nonce, 16)
    #nonce = 21627 + 2
    # print str(nonce)
    gas_price = int(gas_price, 16) * 3 /3
    start_gas = int(start_gas, 16) + 100000
    print str(start_gas)
    start_gas = 4700000  # 4710388#3000000#4712388 # 5183626 / 2
    #start_gas = 4990000
    
    tx = transactions.contract(nonce, gas_price, start_gas, value, contract_data).sign(priv_key)
                     
    # print contract_data                  
    tx_hex = b2h(rlp.encode(tx))
    tx_hash = b2h(tx.hash)
    print(tx_hex)
    print tx_hash
    
    # print str(tx_hash)
    if use_ether_scan:
        params = [{"hex" : "0x" + tx_hex }]
    else:
        params = ["0x" + tx_hex]
            
    return_value = (json_call("eth_sendRawTransaction", params), contract_hash)
    wait_for_confirmation(tx_hash)
    return return_value        

def call_function(priv_key, value, contract_hash, contract_abi, function_name, args):
    translator = ContractTranslator(contract_abi)
    call = translator.encode_function_call(function_name, args)
    return make_transaction(priv_key, contract_hash, value, call)
    

def call_const_function(priv_key, value, contract_hash, contract_abi, function_name, args):
    src_address = b2h(utils.privtoaddr(priv_key))    
    translator = ContractTranslator(contract_abi)
    call = translator.encode_function_call(function_name, args)  
    nonce = get_num_transactions(src_address)
    gas_price = get_gas_price_in_wei()
    
    start_gas = eval_startgas(src_address, contract_hash, value, b2h(call), gas_price)    
    nonce = int(nonce, 16)
    gas_price = int(gas_price, 16)
    start_gas = int(start_gas, 16) + 100000
    start_gas = 612288 

    
    params = { "from" : "0x" + src_address,
               "to"   : "0x" + contract_hash,
               "gas"  : "0x" + "%x" % start_gas,
               "gasPrice" : "0x" + "%x" % gas_price,
               "value" : "0x" + str(value),
               "data" : "0x" + b2h(call) }
    
    return_value = json_call("eth_call", [params])
    print return_value
    return_value = h2b(return_value[2:])  # remove 0x
    return translator.decode(function_name, return_value)



def make_new_filter(contract_address, topic):
    params = { "fromBlock" : "0x1",
               "address": "0x" + contract_address,
               "topics" : [topic] }
    filter_id = json_call("eth_newFilter", [params])
    # filter_id = "0x0"
    print filter_id
    params = filter_id
    print json_call("eth_getFilterLogs", [params])

def wait_for_confirmation(tx_hash):
    
    params = None
    if use_ether_scan:
        params = { "txhash" : "0x" + tx_hash }
    else:
        params = "0x" + tx_hash
    round = 0
    while(True):
        print "waiting for confirmation round " + str(round)
        round += 1 
        result = json_call("eth_getTransactionReceipt", [params])
        # print result
        if result is None:
            if(global_wait_for_confirm):
                time.sleep(10)
                continue
            else:
                time.sleep(1)
                return                
        # print str(result["blockHash"])
        if not(result["blockHash"] is None):
            return result
        time.sleep(10)
        
        



from pycoin.serialize import b2h, h2b
from pycoin import encoding
import rlp
from ethereum import tester, utils, abi, blocks, transactions
import requests
import json
import jsonrpc
import time
from ethereum.abi import ContractTranslator
from ethereum.utils import mk_contract_address


class agt_leaf:
    def is_leaf(self):
        return True
    
    def __init__(self, value, counter_16_bytes_stream):
        self.min = counter_16_bytes_stream
        self.max = counter_16_bytes_stream
        self.value = h2b("00") * 16 + utils.sha3(value)[16:32]

    def override_min(self, new_min):
        self.min = new_min
        
    def override_max(self, new_max):
        self.max = new_max
    
    def override_value(self, new_value):
        self.value = h2b("00") * 16 + utils.sha3(new_value)[16:32]

class agt_node:
    def is_leaf(self):
        return False
    
    def __init__(self, left_node, right_node):
        self.min = left_node.min
        self.max = right_node.max
        
        self.left = left_node
        self.right = right_node
                
        left_data =  left_node.max + left_node.min + left_node.value  
        right_data = right_node.max + right_node.min + right_node.value 
        
        
        #print b2h(right_data)        
        
        self.value =  h2b("00") * 16 + utils.sha3(left_data + right_data)[16:32]
        
    def override_min(self, new_min):
        self.min = new_min
        
    def override_max(self, new_max):
        self.max = new_max         
        
    def get_branch(self, index, depth):
        if( depth == 0 ):
            raise NameError('depth should not be zero')
        
        
        countersBranch = []
        hashesBranch = []
        leaf_counter = None
        leaf_hash = None

        child_node = None
        second_child_node = None        
        go_right = (((1 << (depth-1)) & index) > 0)
        if( go_right ):
            child_node = self.right
            second_child_node = self.left
        else:
            child_node = self.left
            second_child_node = self.right
         
        if( not child_node.is_leaf() ):
            (countersBranch, hashesBranch,leaf_counter,leaf_hash) = child_node.get_branch(index,depth-1)
        else:
            if( depth != 1 ):
                raise NameError('depth should be one')
            leaf_counter = child_node.min
            leaf_hash = child_node.value
            
        countersBranch.append(second_child_node.max + second_child_node.min)
        hashesBranch.append(second_child_node.value)
        
        return (countersBranch, hashesBranch,leaf_counter,leaf_hash)
    
    def get_node(self, depth, index):
        if( depth == 0 ):
            return self
        go_right = (((1 << (depth-1)) & index) > 0)
        child = None
        if( go_right ):
            child = self.right
        else:
            child = self.left
            
        if( child.is_leaf() ):
            if( depth != 1 ):
                raise NameError('depth should be one')
            return child 
        
        return child.get_node(depth-1, index)                        
    
################################################################################

def build_agt_from_leafs( leaf_array ):
    nodes_array = leaf_array
    while(len(nodes_array) > 1 ):
        next_level = []        
        for i in range(len(nodes_array)/2):
            node = agt_node( nodes_array[2*i], nodes_array[2*i+1])  
            next_level.append(node)
        nodes_array = next_level
        
    return nodes_array[0]

################################################################################

def build_valid_agt( num_leaves ):
    nodes_array = []
    for i in range(num_leaves):
        value = utils.sha3(i)
        counter = h2b( "%032x" % i)
        leaf = agt_leaf(value, counter)
        nodes_array.append(leaf)

    return build_agt_from_leafs(nodes_array)       

################################################################################

def build_agt_with_duplications( num_leaves, duplicated_share_source_index, duplicated_share_dest_index, num_duplicates ):
    nodes_array = []
    for i in range(num_leaves):
        value = utils.sha3(i)
        counter = h2b( "%032x" % i)
        leaf = agt_leaf(value, counter)
        nodes_array.append(leaf)
        
        if( (i >= duplicated_share_dest_index) and (i < duplicated_share_dest_index + num_duplicates) ):
            nodes_array[i] = nodes_array[duplicated_share_source_index + i - duplicated_share_dest_index]
            

    return build_agt_from_leafs(nodes_array)       

################################################################################

def build_agt_with_duplication_pattern( num_leaves, start_pattern_index, duplication_frequency ):
    nodes_array = []
    for i in range(num_leaves):
        value = utils.sha3(i)
        counter = h2b( "%032x" % i)
        leaf = agt_leaf(value, counter)
        nodes_array.append(leaf)

        if( i > 0 and i >= start_pattern_index ):
            if( ((i - start_pattern_index) % duplication_frequency) == 0 ):
                nodes_array[i] = nodes_array[i-1]
            

    return build_agt_from_leafs(nodes_array)       


################################################################################

def bytestream_to_int( stream ):
    return int(b2h(stream),16)

def make_verify_agt_input( root, depth, index ):
    (counters_branch, hashes_branch,leaf_counter,leaf_hash) = root.get_branch(index,depth)
    
    rootHash = bytestream_to_int(root.value)
    rootMin = bytestream_to_int(root.min)
    rootMax = bytestream_to_int(root.max)    
    leafHash = bytestream_to_int(leaf_hash)
    leafCounter = bytestream_to_int(leaf_counter)
    branchIndex = index
    
    countersBranch = []
    for i in range(len(counters_branch)):
        countersBranch.append(bytestream_to_int(counters_branch[i]))
        
    hashesBranch = []        
    for i in range(len(hashes_branch)):
        hashesBranch.append(bytestream_to_int(hashes_branch[i]))
        
    return [rootHash,rootMin,rootMax,leafHash,leafCounter,branchIndex,countersBranch,hashesBranch] 

def make_js_input( params, varSuffixName, object_name):
    print "////////////////////////////////////////////////////////////////////////////////"
    print "// this code was generated automatically"
    print ""
    print "var rootHash" + varSuffixName + " = new BigNumber(\"" + "0x%x" % params[0] + "\");"
    print "var rootMin" + varSuffixName + " = new BigNumber(\"" + "0x%x" % params[1] + "\");"    
    print "var rootMax" + varSuffixName + " = new BigNumber(\"" + "0x%x" % params[2] + "\");"
    print "var leafHash" + varSuffixName + " = new BigNumber(\"" + "0x%x" % params[3] + "\");"    
    print "var leafCounter" + varSuffixName + " = new BigNumber(\"" + "0x%x" % params[4] + "\");"    
    print "var branchIndex" + varSuffixName + " = new BigNumber(\"" + "0x%x" % params[5] + "\");"
    print "var countersBranch" + varSuffixName + " = ["
    for counter in params[6]:
        print "\tnew BigNumber(\"" + "0x%x" % counter + "\"),"
    print "];"
    print "var hashesBranch" + varSuffixName + " = ["
    for counter in params[7]:
        print "\tnew BigNumber(\"" + "0x%x" % counter + "\"),"
    print "];"
    
    print "var " + object_name + " = new helper.VerifyAgtInput( rootHash" + varSuffixName\
    + ", rootMin" + varSuffixName\
    + ", rootMax" + varSuffixName\
    + ", leafHash" + varSuffixName + ", leafCounter" + varSuffixName\
    + ", branchIndex" + varSuffixName\
    + ", countersBranch" + varSuffixName\
    + ", hashesBranch" + varSuffixName + " );"    
          
    print "module.exports." + varSuffixName + " = function ( ) {"
    print "\treturn " + object_name + ";"
    print "}"
            
################################################################################

def make_valid_inputs():
    root = build_valid_agt(2**10)
    
    # first index
    params = make_verify_agt_input(root,10,0)    
    make_js_input(params, "ValidAgtFirstShare", "validAgtFirstShare")
    
    # last index
    params = make_verify_agt_input(root,10,1023)    
    make_js_input(params, "ValidAgtLastShare", "validAgtLastShare")
    
    # middle index
    params = make_verify_agt_input(root,10,500)    
    make_js_input(params, "ValidAgtMiddleShare", "validAgtMiddleShare")
    
def make_duplications_inputs():
    
    ### single duplication
    
    # duplication in the beginning
    root = build_agt_with_duplications( 2**10, 0, 1, 1 )
    params = make_verify_agt_input(root,10,1)
    make_js_input(params, "DuplicationSingleAgtFirstShare1", "duplicationSingleFirstShare1")    

    # duplication in the beginning and end
    root = build_agt_with_duplications( 2**10, 0, 1023, 1 )
    params = make_verify_agt_input(root,10,1023)
    make_js_input(params, "DuplicationSingleAgtFirstShare2", "duplicationSingleFirstShare2")    

    # duplication in the end
    root = build_agt_with_duplications( 2**10, 1022, 1023, 1 )
    params = make_verify_agt_input(root,10,1023)
    make_js_input(params, "DuplicationSingleAgtLastShare", "duplicationSingleLastShare")    

    # duplication in the middle
    root = build_agt_with_duplications( 2**10, 210, 607, 1 )
    params = make_verify_agt_input(root,10,607)
    make_js_input(params, "DuplicationSingleAgtMiddleShare", "duplicationSingleMiddleShare")    

    ### bulk duplication
    
    # duplication in the beginning
    root = build_agt_with_duplications( 2**10, 0, 1, 100 )
    params = make_verify_agt_input(root,10,50)
    make_js_input(params, "DuplicationBulkAgtFirstShare1", "duplicationBulkFirstShare1")    

    # duplication in the beginning and end
    root = build_agt_with_duplications( 2**10, 0, 1023-100, 100 )
    params = make_verify_agt_input(root,10,1023)
    make_js_input(params, "DuplicationBulkAgtFirstShare2", "duplicationBulkFirstShare2")    

    # duplication in the end
    root = build_agt_with_duplications( 2**10, 1023-200, 1023-100, 100 )
    params = make_verify_agt_input(root,10,1000)
    make_js_input(params, "DuplicationBulkAgtLastShare", "duplicationBulkLastShare")    

    # duplication in the middle
    root = build_agt_with_duplications( 2**10, 210, 607, 100 )
    params = make_verify_agt_input(root,10,657)
    make_js_input(params, "DuplicationBulkAgtMiddleShare", "duplicationBulkMiddleShare")    
    
    ### pattern duplication
    root = build_agt_with_duplication_pattern( 2**10, 100, 300 )
    params = make_verify_agt_input(root,10,400)    
    make_js_input(params, "DuplicationPatternAgtMiddleShare", "duplicationPatternMiddleShare")
    
def make_invalid_agt():
    # different leaf counter
    root = build_valid_agt( 2**10 ) 
    params = make_verify_agt_input(root,10,0x4A)
    params[4] += 1
    make_js_input(params, "InvalidAgtLeafCounter", "invalidAgtLeafCounter")    
    
    # different leaf value
    root = build_valid_agt( 2**10 ) 
    leaf = root.get_node(10,0x4A)
    leaf.override_value(utils.sha3("sivan"))
    params = make_verify_agt_input(root,10,0x4A)
    make_js_input(params, "InvalidAgtLeafValue", "invalidAgtLeafValue")
    
    # left.min >= left.max    
    root = build_valid_agt( 2**8 ) 
    node = root.get_node(4, 0x0A)
    node.override_min(node.max)
    params = make_verify_agt_input(root,8,0xB0)
    make_js_input(params, "InvalidAgtNodeMinGeqLeftMax", "invalidAgtNodeMinGeqLeftMax")

    # right.min >= right.max
    root = build_valid_agt( 2**8 ) 
    node = root.get_node(4, 0x0B)
    node.override_min(node.max)
    params = make_verify_agt_input(root,8,0xA0)
    make_js_input(params, "InvalidAgtNodeMinGeqRightMax", "invalidAgtNodeMinGeqRightMax")
    
    # left.min > left.max for leaf
    root = build_valid_agt( 2**8 )
    node = root.get_node(8, 0x0A)
    node.override_min(h2b( "%032x" % (int(b2h(node.max),16)+1)))
    params = make_verify_agt_input(root,8,0x0B)
    make_js_input(params, "InvalidAgtLeftLeafMinGtMax", "invalidAgtLeftLeafMinGtMax")

    # right.min > right.max for leaf
    root = build_valid_agt( 2**8 )
    node = root.get_node(8, 0x0B)
    node.override_min(h2b( "%032x" % (int(b2h(node.max),16)+1)))
    params = make_verify_agt_input(root,8,0x0A)
    make_js_input(params, "InvalidAgtRightLeafMinGtMax", "invalidAgtLeftRightMinGtMax")

    # left.max >= right.min for a node
    root = build_valid_agt( 2**8 )
    nodeLeft = root.get_node(4, 0x0A)
    nodeRight = root.get_node(4, 0x0B)
    nodeLeft.override_max(nodeRight.min)
    params = make_verify_agt_input(root,8,0xB1)
    make_js_input(params, "InvalidAgtLeftMaxGeRightMin", "invalidAgtLeftMaxGeRightMin")
    
    # invalid root.min data    
    root = build_valid_agt( 2**8 )
    params = make_verify_agt_input(root,8,0)
    params[1] += 1 
    make_js_input(params, "InvalidAgtRootMin", "invalidAgtRootMin")    
    
    # invalid root.max data    
    root = build_valid_agt( 2**8 )
    params = make_verify_agt_input(root,8,0)
    params[2] += 1 
    make_js_input(params, "InvalidAgtRootMax", "invalidAgtRootMax")    

    # invalid root.hash data    
    root = build_valid_agt( 2**8 )
    params = make_verify_agt_input(root,8,0)
    params[0] += 1 
    make_js_input(params, "InvalidAgtRootHash", "invalidAgtRootHash")    
   

################################################################################
'''
funds_in_block_reward = int(300/5)
time_in_months = 1
num_trials_per_month = 4*60*24*30
hash_power = 0.1

n = num_trials_per_month * time_in_months 
k = n - funds_in_block_reward
p = hash_power 

lamb = p * num_trials_per_month * time_in_months
x = 0.99 * lamb
# pr [ X <= x ]
print lamb
print x
sd
#odds_of_bankrupt = 
'''
   
    
################################################################################

if( True ):
    print "var BigNumber = require('bignumber.js');"
    print "const helper = require('./helpers');"
    
    
    make_valid_inputs()
    make_duplications_inputs()
    make_invalid_agt()
    
    sd    
    
    
# first index
#params = make_verify_agt_input(root,10,30)






key = h2b("4f3edf983ac636a65a842ce7c78d9aa706d3b113bce9c46f30d7d21715b23b1d")



owners = [0x6d87462cB31C1217cf1eD61B4FCC37F823c61624, 0xe034afdcc2ba0441ff215ee9ba0da3e86450108d, 0x38b6a9aedee2238f7c0540a6ff0f71ac4a6b0948] 
(contract_data_ethash, abi_ethash) = get_contract_data("./contracts/TestPool", [owners])


#(str, contract_hash_ethash) = upload_contract( key, contract_data_ethash, 0 )
#zelda


contract_hash_ethash = "e0f8cee346a702cca192a6ec807ff89b4c6bc70e"




print call_const_function(key, 0, contract_hash_ethash, abi_ethash, "verifyAgtDebugForTesting", params)
print "0x%x" % params[0]

'''
failure_cntr = 0
for i in range(256):
    params = make_verify_agt_input(root,8,i)
    ret_val = call_const_function(key, 0, contract_hash_ethash, abi_ethash, "verifyAgtDebugForTesting", params)
    if( ret_val[0] != 0 ):
        failure_cntr += 1
        print i
        sd
    print i
    
print failure_cntr
'''